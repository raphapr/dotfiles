#!/bin/bash

set -e

CACHE_FILE="$HOME/.cache/gclone-repos"
CACHE_TTL_MINUTES=1440 # 24 hours
HISTORY_CMD="${GCLONE_HISTORY_CMD:-atuin history list --format '{command}'}"

if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
  echo "Usage: gclone [org/repo_name] [options]"
  echo ""
  echo "Clone a GitHub repository using ghq"
  echo ""
  echo "Options:"
  echo "  -h, --help     Show this help message"
  echo "  -r, --refresh  Refresh the repository cache"
  echo ""
  echo "Environment variables:"
  echo "  GCLONE_HISTORY_CMD     History command (default: atuin history list --format '{command}')"
  echo ""
  echo "If no argument is provided, an interactive fzf menu will be shown"
  echo "with repositories from your history."
  echo ""
  echo "Note: This script uses ghq for cloning. Configure ghq root directory"
  echo "with 'git config --global ghq.root <path>'"
  exit 0
fi

if [ "$1" = "--refresh" ] || [ "$1" = "-r" ]; then
  if [ -f "$CACHE_FILE" ]; then
    rm "$CACHE_FILE"
    echo "Cache refreshed"
  else
    echo "No cache to refresh"
  fi
  exit 0
fi

if [ -z "$1" ]; then
  CACHE_DIR=$(dirname "$CACHE_FILE")

  if [ ! -d "$CACHE_DIR" ]; then
    mkdir -p "$CACHE_DIR"
  fi

  if [ ! -f "$CACHE_FILE" ] || [ $(find "$CACHE_FILE" -mmin +$CACHE_TTL_MINUTES 2>/dev/null | wc -l) -gt 0 ]; then
    eval "$HISTORY_CMD" | grep -oP '(?<=git clone git@github\.com:)[^[:space:]]+' | sed 's/\.git$//' | sort -u >"$CACHE_FILE"
  fi

  REPO_INPUT=$(cat "$CACHE_FILE" | fzf --prompt="Select repo: ")
  if [ -z "$REPO_INPUT" ]; then
    echo "No repository selected"
    exit 1
  fi
else
  REPO_INPUT="$1"
fi

REPO_INPUT="${REPO_INPUT%.git}"
REPO_URL="git@github.com:$REPO_INPUT"

if ! command -v ghq >/dev/null 2>&1; then
  echo "Error: ghq is not installed. Please install ghq to use this script."
  exit 1
fi

echo "Cloning $REPO_URL..."
ghq clone "$REPO_URL"

TARGET_PATH=$(ghq list --full-path --exact "github.com/$REPO_INPUT")
echo "Repository cloned successfully to $TARGET_PATH"
